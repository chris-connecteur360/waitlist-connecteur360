---
// src/pages/[lang].astro
import Layout from '../layouts/Layout.astro';
import { languages, getLangFromUrl, useTranslations } from '../i18n';
import "../styles/global.css";

export function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({
    params: { lang },
  }));
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Note : La logique 'otherLang' est supprimée car nous avons maintenant 3 langues.
---

<Layout>
    <div class="bg-[#F9F9FB] min-h-screen flex flex-col">
        <main class="flex-grow flex items-center justify-center w-full py-10">
            <div class="max-sm:w-[90%] sm:max-w-[480px] w-full p-8 bg-white space-y-7 rounded-[16px] shadow-card">
                
                {/* Logo */}
                <div class="flex items-center justify-center">
                    <img src="/logos/logo.svg" alt="Connecteur 360" class="h-12">
                </div>
                
                {/* Contenu Texte */}
                <div class="w-full space-y-2 text-[#0D0D12]">
                    <h1 class="text-[22px] leading-[130%] font-bold mb-4 text-center">{t('hero.title')}</h1>
                    <p class="text-[15px] leading-relaxed" set:html={t('hero.intro')} />
                    <div class="text-[15px] leading-relaxed" set:html={t('hero.features')} />
                    <p class="text-[15px] font-medium mt-4" set:html={t('hero.impact_intro')} />
                    <div class="text-[15px] leading-relaxed" set:html={t('hero.impact_list')} />
                    <p class="text-[15px] italic mt-4 text-gray-600" set:html={t('hero.outro')} />
                </div>

                {/* --- FORMULAIRE --- */}
                <form id="waitlist-form" class="space-y-[14px]">
                    <div class="flex gap-3">
                        <input 
                            type="text" 
                            name="prenom"
                            required
                            placeholder={t('form.firstname')} 
                            class="text-[14px] px-3 border border-[#E5E7EB] w-1/2 py-[10px] rounded-[8px] focus:outline-none focus:ring-1 focus:ring-[#0052CC]"
                        >
                        <input 
                            type="text" 
                            name="nom"
                            required
                            placeholder={t('form.lastname')} 
                            class="text-[14px] px-3 border border-[#E5E7EB] w-1/2 py-[10px] rounded-[8px] focus:outline-none focus:ring-1 focus:ring-[#0052CC]"
                        >
                    </div>

                    <input 
                        type="text" 
                        name="pays"
                        required
                        placeholder={t('form.country')} 
                        class="text-[14px] px-3 border border-[#E5E7EB] w-full py-[10px] rounded-[8px] focus:outline-none focus:ring-1 focus:ring-[#0052CC]"
                    >

                    <input 
                        type="email" 
                        name="email"
                        required
                        placeholder={t('form.email.placeholder')} 
                        class="text-[14px] px-3 border border-[#E5E7EB] w-full py-[10px] rounded-[8px] focus:outline-none focus:ring-1 focus:ring-[#0052CC]"
                    >
                    <button id="submit-btn" type="submit" class="text-center text-[14px] font-medium text-white w-full bg-[#0052CC] hover:bg-[#0043a8] transition-colors py-[10px] rounded-[8px]">
                        {t('form.submit')}
                    </button>
                    
                    <p id="form-message" class="text-center text-[14px] hidden"></p>
                </form>
            </div>
        </main>

        {/* FOOTER MULTILANGUE */}
        <footer class="py-[18px] flex flex-col sm:flex-row items-center justify-center gap-4 w-full">
            <p class="text-[14px] text-gray-500">{t('footer.copyright')}</p>
            
            {/* Séparateur visible uniquement sur desktop */}
            <span class="hidden sm:block text-gray-300">|</span>
            
            {/* Liste des langues */}
            <div class="flex gap-4">
                {Object.keys(languages).map((l) => (
                    <a 
                        href={`/${l}`} 
                        class={`text-[14px] hover:underline cursor-pointer ${l === lang ? ' text-[#0052CC]' : 'text-gray-500'}`}
                    >
                        {l.toUpperCase()}
                    </a>
                ))}
            </div>
        </footer>
    </div>
</Layout>

<script>
    // Le script reste identique car il gère le formulaire de manière générique
    const form = document.getElementById('waitlist-form') as HTMLFormElement;
    const messageEl = document.getElementById('form-message');
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

    if (form && messageEl && submitBtn) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const originalBtnText = submitBtn.innerText;
            submitBtn.disabled = true;
            submitBtn.innerText = "...";
            messageEl.classList.add('hidden');
            messageEl.className = "text-center text-[14px] hidden"; 

            const formData = new FormData(form);

            try {
                const response = await fetch('/api/waitlist', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                messageEl.classList.remove('hidden');
                messageEl.innerText = data.message;

                if (response.ok) {
                    messageEl.classList.add('text-green-600');
                    form.reset();
                } else {
                    messageEl.classList.add('text-red-600');
                }

            } catch (error) {
                messageEl.classList.remove('hidden');
                messageEl.innerText = "Une erreur est survenue.";
                messageEl.classList.add('text-red-600');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = originalBtnText;
            }
        });
    }
</script>