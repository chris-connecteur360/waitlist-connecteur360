---
// src/pages/[lang].astro
import Layout from '../layouts/Layout.astro';
import { languages, getLangFromUrl, useTranslations } from '../i18n';
import "../styles/global.css";

export function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({
    params: { lang },
  }));
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const otherLang = lang === 'fr' ? 'en' : 'fr';
---

<Layout>
    <div class="bg-[#F9F9FB] min-h-screen flex flex-col">
        <main class="flex-grow flex items-center justify-center w-full py-10">
            <div class="max-sm:w-[90%] sm:max-w-[480px] w-full p-8 bg-white space-y-7 rounded-[16px] shadow-card">
                
                {/* Logo */}
                <div class="flex items-center justify-center">
                    <img src="/logos/logo.svg" alt="Connecteur 360" class="h-12">
                </div>
                
                {/* Contenu Texte */}
                <div class="w-full space-y-2 text-[#0D0D12]">
                    <h1 class="text-[22px] leading-[130%] font-bold mb-4 text-center">{t('hero.title')}</h1>
                    <p class="text-[15px] leading-relaxed" set:html={t('hero.intro')} />
                    <div class="text-[15px] leading-relaxed" set:html={t('hero.features')} />
                    <p class="text-[15px] font-medium mt-4" set:html={t('hero.impact_intro')} />
                    <div class="text-[15px] leading-relaxed" set:html={t('hero.impact_list')} />
                    <p class="text-[15px] italic mt-4 text-gray-600" set:html={t('hero.outro')} />
                </div>

                {/* --- FORMULAIRE --- */}
                <form id="waitlist-form" class="space-y-[14px]">
                    <input 
                        type="email" 
                        name="email"
                        required
                        placeholder={t('form.email.placeholder')} 
                        class="text-[14px] px-3 border border-[#E5E7EB] w-full py-[10px] rounded-[8px] focus:outline-none focus:ring-1 focus:ring-[#0052CC]"
                    >
                    <button id="submit-btn" type="submit" class="text-center text-[14px] font-medium text-white w-full bg-[#0052CC] hover:bg-[#0043a8] transition-colors py-[10px] rounded-[8px]">
                        {t('form.submit')}
                    </button>
                    
                    {/* Zone de message pour le retour utilisateur */}
                    <p id="form-message" class="text-center text-[14px] hidden"></p>
                </form>
            </div>
        </main>

        <footer class="py-[18px] flex items-center justify-center gap-6 w-full">
            <p class="text-[14px] text-gray-500">{t('footer.copyright')}</p>
            <a href={`/${otherLang}`} class="text-[14px] text-gray-500 hover:underline cursor-pointer">
                {otherLang === 'fr' ? 'FR' : 'EN'}
            </a>
        </footer>
    </div>
</Layout>

<script>
    // Logique Client-Side pour envoyer le formulaire
    const form = document.getElementById('waitlist-form') as HTMLFormElement;
    const messageEl = document.getElementById('form-message');
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

    if (form && messageEl && submitBtn) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault(); // Empêche le rechargement de la page
            
            // État de chargement
            const originalBtnText = submitBtn.innerText;
            submitBtn.disabled = true;
            submitBtn.innerText = "...";
            messageEl.classList.add('hidden');
            messageEl.className = "text-center text-[14px] hidden"; // Reset classes

            const formData = new FormData(form);

            try {
                const response = await fetch('/api/waitlist', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                messageEl.classList.remove('hidden');
                messageEl.innerText = data.message;

                if (response.ok) {
                    // Succès : Texte vert et reset du formulaire
                    messageEl.classList.add('text-green-600');
                    form.reset();
                } else {
                    // Erreur : Texte rouge
                    messageEl.classList.add('text-red-600');
                }

            } catch (error) {
                messageEl.classList.remove('hidden');
                messageEl.innerText = "Une erreur est survenue. Réessayez.";
                messageEl.classList.add('text-red-600');
            } finally {
                // Remettre le bouton à la normale
                submitBtn.disabled = false;
                submitBtn.innerText = originalBtnText;
            }
        });
    }
</script>